---
title: "Superspreading negative binomial simulations"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r global-options, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
NegBinmixturedeviate<- function(m, p, R0D, k, delta) {  
  #Returns a vector of m Poisson mixture deviates
  # Assumes a finite mixture of two Poisson distributions, with prob p and 1-p respectively, 0<p<1
  #1 = success = direct contact
  #0 = failure = aerosol
  #rbinom = one bernoulli trial for direct transmission
  #n = number of observations = 1
  #size = number of trials =1 (bernoulli) per observation
  #if success, deviate = rpois(R0D) otherwise aerosol
  R0A<-R0D +delta
  deviate<-numeric(m) #number of deviates
  for(i in 1:m){
deviate[i]<-ifelse(rbinom(1, size=1, prob = p)==1, rnbinom(1,mu=R0A, size=k), rnbinom(1,mu=R0D, size=k))
  }
  return(deviate)
}

NegBinmixturebranch<- function(n,p, R0D, k, delta) {
  #Arguments:
  #n = number of generations
  #Returns number of cases per generation as a vector
  #Uses Poissonmixturedeviate to generate random variates from mixture distribution
  
	z <- c(1,rep(0,n))#one infected case in generation 0 
	for (i in 2:(n+1)) {
z[i]<-ifelse(z[i-1]==0, 0, sum(NegBinmixturedeviate(z[i-1], p=p, R0D=R0D, k=k, delta=delta)))	  
			}
			return(z)
			}

NegBinbranch<- function(n,R0, k) {
  #Arguments:
  #n = number of generations
  #Returns number of cases per generation as a vector
  #Uses Poissonmixturedeviate to generate random variates from mixture distribution
  
	z <- c(1,rep(0,n))#one infected case in generation 0 
	for (i in 2:(n+1)) {
z[i]<-ifelse(z[i-1]==0, 0, sum(rnbinom(z[i-1],mu=R0,size=k)))	  
			}
			return(z)
			}

NegBinbranchw <- function(R0,k) {
  #returns n = the number of generations that it takes to have a cluster greater than 50 from a Poisson mixture offspring distribution
  
  n<-1
	z <- c(1,rep(0,n)) #n = number of generations after generation 0
	#one infected case in generation 0
	cluster<-sum(z)
	while(cluster<50){
	    i<-n+1
			z[i] <- sum(rnbinom(z[i-1],mu=R0,size=k))
			cluster<-cluster+z[i]
      n<-n+1
      if(z[i]==0){
        break #break out of loop of cluster dies out
      }
			}
			#return(c(z, cluster, n))
if(cluster<50)
	{n<-NA} #prob of extinction zinfinity predicts proportion of clusters that die out
	return(n)
			}

		
NegBinmixturebranchw<- function(p, R0D, k, delta) {  
#returns n = the number of generations that it takes to have a cluster greater than 50 from a Poisson mixture offspring distribution
R0A<-R0D+delta
  n<-1 #generation time
	z <- c(1,rep(0,n))
	#one infected case in generation 0 
	cluster<-sum(z)
	while(cluster<50){
	  #number of poisson rvs needed per case = z[i-1], then add together to get the number of new infections in that generation
	    i<-n+1
	    
	z[i]<-ifelse(z[i-1]==0, 0, sum(NegBinmixturedeviate(z[i-1], p=p, R0D=R0D, k=k, delta=delta)))	 

		cluster<-cluster+z[i]
      n<-n+1
      if(z[i]==0){
        break #if no cases break out of while loop
      }
			}
	#		return(c(z, cluster, n)) as a check
	if(cluster<50)
	{n<-NA}
	return(n)
			}


Poissonmixturebranchw2<- function(p, R0D, R0A) {  
#returns n = the number of generations that it takes to have a cluster greater than 50 from a Poisson mixture offspring distribution

  n<-1 #generation time
	z <- c(1,rep(0,n))
	#one infected case in generation 0 
	cluster<-sum(z)
	while(cluster<50){
	  #number of poisson rvs needed per case = z[i-1], then add together to get the number of new infections in that generation
	    i<-n+1
z[i] <- sum(rmixture(z[i-1], probs = c(p, 1-p), models = expression(rpois(R0D), rpois(R0A))))#params$R0D
		cluster<-cluster+z[i]
      n<-n+1
      if(z[i]==0){
        break #if no cases break out of while loop
      }
			}
	#		return(c(z, cluster, n)) as a check
	if(cluster<50)
	{n<-NA}
	return(n)
			}

```


```{r}
mydata<-data.frame(cases=NegBinmixturedeviate(100000, p=0.1, R0D=1.1, k=0.5,delta=(2-1.1)/0.1))
data<-data.frame(cases=rnbinom(100000, mu=2, size=0.5))
combdat<-bind_rows(list(Mixture=mydata,Baseline=data),
                           .id="model")
ggplot(combdat,aes(cases,y=stat(prop),fill=model))+
   scale_fill_manual(values=c("red","blue"))+
  geom_bar(alpha=0.5,position = 'identity') 
```

```{r}
count(mydata, cases)
```
If $p$ is small but $\delta$ is large, then the range of cases is large.

Now we wish to plot typical chains.

First lets look at the mean size of small (clusters < 10) and large clusters (>10).
The median clusters are typically bigger in the standard model than the mixture model but the mean is smaller, and mean chain sizes conditioned on extinction are similar in both models. If chopping the chain should condition on extinction/non-extinction?
```{r}
nsims<-1000
ngen=10
cluster<-numeric(nsims)
for(i in 1:nsims) cluster[i]<-sum(NegBinmixturebranch(ngen,p=0.1, R0D=1.1, k=0.5, delta=9)) 
c(mean(cluster[which(cluster>=10)]), range(cluster[which(cluster>=10)]))
median(cluster[which(cluster>=10)])
mean(cluster[which(cluster<10)])
```
```{r}
nsims<-1000
ngen=10
bcluster<-numeric(nsims)
for(i in 1:nsims) bcluster[i]<-sum(NegBinbranch(ngen, R0=2, k=0.5)) 
c(mean(bcluster[which(bcluster>=10)]), range(bcluster[which(bcluster>=10)]))
median(bcluster[which(bcluster>=10)])
mean(bcluster[which(bcluster<10)])
```
```{r}
nsims<-1000
ngen=20
bcluster<-numeric(nsims)
for(i in 1:nsims) bcluster[i]<-sum(NegBinbranch(ngen, R0=0.87, k=0.5)) 
mean(bcluster[which(bcluster>=10)])
median(bcluster[which(bcluster>=10)])
mean(bcluster[which(bcluster<10)])
```
```{r}
nsims<-1000
ngen=20
cluster<-numeric(nsims)
for(i in 1:nsims) cluster[i]<-sum(NegBinmixturebranch(ngen,p=0.1, R0D=0.5, k=0.5, delta=1)) 
mean(cluster[which(cluster>=10)])
median(cluster[which(cluster>=10)])
mean(cluster[which(cluster<10)])
```

```{r}
nsims<-10
ngen=20
sims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) sims[,i]<-NegBinmixturebranch(ngen,p=0.1, R0D=0.8, k=0.5, delta=1) 
sims
```
Probability of a major outbreak for mixture model is about 0.1.
```{r}
nsims<-10
ngen=10
sims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) sims[,i]<-NegBinmixturebranch(ngen,p=0.1, R0D=1.1, k=0.5, delta=9) 
sims
```
Probability of a major outbreak for standard model is about 0.4. Here four have taken off, but none are as large as the mixture that has taken off?
```{r}
nsims<-10
ngen=10
bsims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) bsims[,i]<-NegBinbranch(ngen, R0=2, k=0.5) 
bsims
```
Plot the mixture chains assuming $k=1/2:
```{r}
ngenmax<-4
simdf<-data.frame(Chain = sims[1:(ngenmax+1),1], ChainNum = "1", Generation=0:ngenmax)
chainnum<-c("2", "3", "4", "5", "6", "7", "8", "9", "10")
for(i in 2:nsims) simdf<-bind_rows(simdf, data.frame(Chain=sims[1:(ngenmax+1),i], ChainNum = chainnum[i-1], Generation=0:ngenmax))
```

```{r}
ggplot(simdf)+
   geom_point(aes(x = Generation, y = Chain, colour=ChainNum))+
  geom_line(aes(x = Generation, y = Chain, colour=ChainNum))
```
```{r}
nsims<-10
ngen=10
sims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) sims[,i]<-NegBinmixturebranch(ngen,p=0.1, R0D=1.1, k=2, delta=9) 
sims
```
Plot the mixture chains assuming $k=2:
```{r}
ngenmax<-8
simdf<-data.frame(Chain = sims[1:(ngenmax+1),1], ChainNum = "1", Generation=0:ngenmax)
chainnum<-c("2", "3", "4", "5", "6", "7", "8", "9", "10")
for(i in 2:nsims) simdf<-bind_rows(simdf, data.frame(Chain=sims[1:(ngenmax+1),i], ChainNum = chainnum[i-1], Generation=0:ngenmax))
```

```{r}
ggplot(simdf)+
   geom_point(aes(x = Generation, y = Chain,colour=ChainNum))+
  geom_line(aes(x = Generation, y = Chain, colour=ChainNum))+
  scale_colour_grey(start = 0, end = .9) +
  theme_bw()
```

```{r}
ggplot(simdf)+
   geom_point(aes(x = Generation, y = Chain, colour=ChainNum))+
  geom_line(aes(x = Generation, y = Chain, colour=ChainNum))
```
```{r}
nsims<-10
ngen=10
bsims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) bsims[,i]<-NegBinbranch(ngen, R0=2, k=2) 
bsims
```
```{r}
nsims<-10000
ngen=10
sims<-matrix(NA, ncol=nsims, nrow=ngen+1)
for(i in 1:nsims) sims[,i]<-NegBinmixturebranch(ngen,p=0.1, R0D=1.1, k=2, delta=9) 
```

```{r}
ngenmax<-8
simdf<-data.frame(Chain = sims[1:(ngenmax+1),1], ChainNum = "1", Generation=0:ngenmax)
chainnum<-paste0("", 1:nsims)
for(i in 2:nsims) simdf<-bind_rows(simdf, data.frame(Chain=sims[1:(ngenmax+1),i], ChainNum = chainnum[i-1], Generation=0:ngenmax))
#View(simdf%>%filter(Generation==8 & Chain==0))
```



```{r}
#R0=4.5
nsims<-10000 #use while loops
kval<-0.5
R0<-2
R0D<-1.1
poissgen2<-numeric(nsims)
for(i in 1:length(poissgen2)) {
  poissgen2[i]<-NegBinbranchw(R0, kval)
}
#vary p =0.05, 0.1, 0.2
poissmixgen2<-numeric(nsims)
for(i in 1:length(poissmixgen2)) poissmixgen2[i]<-NegBinmixturebranchw(p=0.05, R0D, k=kval, delta=(R0-R0D)/0.05)

poissmixgen3<-numeric(nsims)
for(i in 1:length(poissmixgen3)) poissmixgen3[i]<-NegBinmixturebranchw(p=0.1, R0D, k=kval, delta=(R0-R0D)/0.1)
poissmixgen4<-numeric(nsims)
for(i in 1:length(poissmixgen4)) poissmixgen4[i]<-NegBinmixturebranchw(p=0.15, R0D, k=kval, delta=(R0-R0D)/0.15)
check<-c(length(na.omit(poissmixgen2)),length(na.omit(poissmixgen3)), length(na.omit(poissmixgen4)))
poissgen2<-na.omit(poissgen2)
poissmixgen2<-na.omit(poissmixgen2)
poissmixgen3<-na.omit(poissmixgen3)
poissmixgen4<-na.omit(poissmixgen4)

```

Median generation time same for all mixtures. Generation time has most variability for p=0.05, with 25% taking 11 generations or more to take off. 25% take 3 generations or less (most explosive for p =0.05, 0.1). 75% take 9 generations or less if p=0.1 (most explosive?)
```{r}


nsims2<-round(min(check),digits=-2) #round to the nearest 100
pval=rep(c("0.05", "0.1","0.15"), each=2*nsims2)
model=rep(c("baseline","mixture"),each=nsims2)
gentime<-c(poissgen2[1:nsims2], poissmixgen2[1:nsims2], poissgen2[1:nsims2],poissmixgen3[1:nsims2], poissgen2[1:nsims2], poissmixgen4[1:nsims2])
data2=data.frame(p=pval, model ,  GenerationTime=gentime)
 
# grouped boxplot
p<-ggplot(data2, aes(x=p, y=GenerationTime, fill=model)) + 
    geom_boxplot()
p
#ggsave("gentimeR0.pdf", p, height=4, width=5)
```